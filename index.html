<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DASHBOARD</title>
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0b1220;
      --panel: #020617;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.2);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --border: #1f2937;
      --radius-lg: 18px;
      --radius-md: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #020617, #000);
      color: var(--text);
      padding: 18px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      overflow: hidden;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.7);
    }

    /* SIDEBAR (ChatGPT style) */
    .sidebar {
      width: 190px;
      background: #020617;
      border-right: 1px solid var(--border);
      padding: 14px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-title {
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      margin-bottom: 8px;
    }

    .sidebar-section-label {
      font-size: 0.7rem;
      color: var(--text-soft);
      padding: 4px 8px 2px;
    }

    .nav-btn {
      width: 100%;
      text-align: left;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 0.8rem;
      padding: 7px 10px;
      margin-bottom: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .nav-btn span {
      font-size: 0.75rem;
    }

    .nav-btn.active {
      border-color: var(--accent);
      background: rgba(37, 99, 235, 0.2);
      color: var(--accent);
    }

    .nav-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* MAIN AREA */
    .main {
      flex: 1;
      padding: 16px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    /* TOP HEADER */
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 4px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-title {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .app-subtitle {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 5px 9px;
      font-size: 0.75rem;
      color: var(--text-soft);
      display: inline-flex;
      gap: 6px;
      align-items: center;
      background: #020617;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
    }

    .autosave-toggle {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 0.7rem;
      padding: 3px 9px;
      cursor: pointer;
    }

    .autosave-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* VIEWS */
    .view-container {
      flex: 1;
      margin-top: 6px;
      position: relative;
      min-height: 400px;
    }

    .view {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: #020617;
      padding: 10px 10px 12px;
      display: none;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }

    .view.active {
      display: flex;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .panel-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .tiny {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    /* CALENDAR VIEW */
    .calendar-shell {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 260px;
    }

    .cal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .cal-label-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cal-label {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .cal-header-right {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .cal-nav-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-soft);
      font-size: 0.75rem;
      padding: 3px 8px;
      cursor: pointer;
    }

    .cal-nav-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .open-tasks-btn {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 0.75rem;
      padding: 3px 9px;
      cursor: pointer;
    }

    .open-tasks-btn:hover {
      filter: brightness(1.08);
    }

    .cal-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      margin-top: 4px;
    }

    .cal-day-name {
      font-size: 0.7rem;
      text-align: center;
      color: var(--text-soft);
    }

    .cal-day {
      font-size: 0.8rem;
      text-align: center;
      padding: 9px 0;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-soft);
    }

    .cal-day.today {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .cal-day.night {
      border: 1px solid rgba(59, 130, 246, 0.6);
    }

    .cal-day.off {
      border: 1px solid rgba(34, 197, 94, 0.7);
    }

    .cal-day.selected-date {
      outline: 1px solid var(--accent);
      background: rgba(59, 130, 246, 0.18);
      color: var(--text);
    }

    .cal-day.holiday {
      border: 1px solid #facc15;
      background: rgba(250, 204, 21, 0.16);
      color: #eab308;
    }

    .cal-day.extra-off {
      border: 1px dashed rgba(34, 197, 94, 0.9);
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
    }

    .cal-day.lead {
      border: 1px solid #a855f7;
      background: rgba(168, 85, 247, 0.18);
      color: #e9d5ff;
    }

    .calendar-controls {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .calendar-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .day-type-btn,
    .pattern-toggle-btn,
    .pattern-apply-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 0.7rem;
      padding: 3px 8px;
      cursor: pointer;
    }

    .day-type-btn:hover,
    .pattern-toggle-btn:hover,
    .pattern-apply-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .pattern-editor {
      margin-top: 4px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 6px 7px;
      background: #020617;
      display: none;
      flex-direction: column;
      gap: 4px;
      font-size: 0.7rem;
    }

    .pattern-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .pattern-row label {
      width: 80px;
      color: var(--text-soft);
    }

    .pattern-row input {
      flex: 1;
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 3px 7px;
      color: var(--text);
      font-size: 0.7rem;
    }

    /* Month pickers */
    .cal-filter {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 2px 6px;
      background: #020617;
      font-size: 0.75rem;
    }

    .cal-filter-icon {
      font-size: 0.8rem;
    }

    .cal-filter input[type="month"] {
      background: transparent;
      border: none;
      color: var(--text-soft);
      font-size: 0.75rem;
      outline: none;
    }

    .cal-filter input[type="month"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
    }

    /* TODAY PANEL (under calendar) */
    .today-panel {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 8px 9px;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .today-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .today-panel-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .today-panel-date {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .today-panel-body {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .today-focus {
      flex: 2;
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid var(--accent-soft);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      min-width: 180px;
    }

    .focus-text {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .stat-card {
      flex: 1;
      min-width: 140px;
      border-radius: 14px;
      padding: 8px 9px;
      border: 1px dashed var(--border);
      display: flex;
      flex-direction: column;
      gap: 3px;
      background: #020617;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .stat-value {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .stat-badge {
      font-size: 0.65rem;
      color: var(--accent);
    }

    .sleep-controls {
      margin-top: 3px;
      display: flex;
      gap: 4px;
    }

    .sleep-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 0.7rem;
      padding: 2px 7px;
      cursor: pointer;
    }

    .sleep-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Selected-date tasks summary under calendar */
    .selected-tasks-card {
      flex-basis: 100%;
      border-radius: 14px;
      padding: 8px 9px;
      border: 1px dashed var(--border);
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .selected-tasks-list {
      max-height: 110px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .selected-task-line {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.75rem;
      padding: 2px 0;
    }

    .selected-task-text {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .selected-task-meta {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    /* FINANCE VIEW */
    .finance-box {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 8px 9px;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.78rem;
      height: 100%;
      overflow-y: auto;
    }

    .finance-row {
      display: flex;
      justify-content: space-between;
    }

    .finance-label {
      color: var(--text-soft);
    }

    .finance-value {
      font-weight: 500;
    }

    .finance-subtitle {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text);
      margin-top: 4px;
      margin-bottom: 2px;
    }

    .finance-total-line {
      margin-top: 4px;
      font-size: 0.78rem;
      font-weight: 600;
      text-align: right;
      color: var(--text);
    }

    .sidejob-add-row,
    .expenses-add-row {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-top: 2px;
    }

    .sidejob-row,
    .expenses-row {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-top: 4px;
      font-size: 0.75rem;
    }

    .sidejob-name,
    .expense-name {
      flex: 1;
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 3px 7px;
      color: var(--text);
      font-size: 0.75rem;
    }

    .sidejob-input,
    .expense-amount {
      width: 70px;
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 3px 5px;
      color: var(--text);
      font-size: 0.75rem;
      text-align: right;
    }

    .sidejob-add-input,
    .expense-add-name,
    .expense-add-amount {
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 3px 7px;
      color: var(--text);
      font-size: 0.75rem;
    }

    .sidejob-add-btn,
    .expense-add-btn,
    .row-delete-btn,
    .sidejob-week-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 0.7rem;
      padding: 3px 7px;
      cursor: pointer;
    }

    .sidejob-add-btn:hover,
    .expense-add-btn:hover,
    .row-delete-btn:hover,
    .sidejob-week-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .sidejob-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2px;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    /* Finance tabs (Details / Graphs) */
    .finance-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .finance-tab {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 0.75rem;
      padding: 4px 10px;
      cursor: pointer;
    }

    .finance-tab.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(37, 99, 235, 0.18);
    }

    .finance-tab:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    #financeDetailsPanel {
      height: 100%;
    }

    /* Graphs panel */
    .finance-graphs-panel {
      flex: 1;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: #020617;
      padding: 8px 9px;
      display: none;
      flex-direction: column;
      gap: 6px;
    }

    .finance-graphs-panel.active {
      display: flex;
    }

    .finance-graphs-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .graph-selects {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .graph-selects select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 3px 7px;
      color: var(--text-soft);
      font-size: 0.75rem;
      outline: none;
      cursor: pointer;
    }

    .finance-graphs-canvas-wrap {
      flex: 1;
      min-height: 260px;
      border-radius: var(--radius-md);
      border: 1px dashed var(--border);
      padding: 6px;
    }

    .finance-graphs-canvas-wrap canvas {
      width: 100%;
      height: 100%;
    }

    /* TASK DRAWER */
    .drawer-overlay {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
      display: none;
      justify-content: flex-end;
      align-items: stretch;
      z-index: 30;
    }

    .drawer-overlay.open {
      display: flex;
    }

    .drawer {
      width: 340px;
      max-width: 100%;
      background: #020617;
      border-left: 1px solid var(--border);
      padding: 10px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: -18px 0 35px rgba(0, 0, 0, 0.7);
    }

    .drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .drawer-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .drawer-close {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 0.75rem;
      padding: 2px 7px;
      cursor: pointer;
    }

    .drawer-close:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .tasks {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-input-row {
      display: flex;
      gap: 6px;
    }

    .task-input-row input {
      flex: 1;
      background: #020617;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 9px;
      color: var(--text);
      font-size: 0.8rem;
    }

    .task-input-row button {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      padding: 6px 10px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .task-input-row button:hover {
      filter: brightness(1.1);
    }

    .task-list {
      max-height: 180px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 7px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid var(--border);
      margin-bottom: 4px;
    }

    .task-main {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-check {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      cursor: pointer;
    }

    .task-text {
      font-size: 0.8rem;
    }

    .task-text.done {
      text-decoration: line-through;
      color: var(--text-soft);
    }

    .task-delete {
      font-size: 0.7rem;
      color: var(--text-soft);
      cursor: pointer;
    }

    .task-imp-btn {
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--text-soft);
      user-select: none;
    }

    .task-imp-btn.important {
      color: var(--accent);
    }

    .notes-area {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      background: #020617;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 8px 9px;
      color: var(--text);
      font-size: 0.8rem;
    }

    .footer {
      margin-top: 4px;
      font-size: 0.7rem;
      color: var(--text-soft);
      text-align: right;
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      .app {
        border-radius: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-title">DASHBOARD</div>
      <div class="sidebar-section-label">Views</div>
      <button class="nav-btn active" data-view="calendar">
        Calendar
        <span>main</span>
      </button>
      <button class="nav-btn" data-view="finance">
        Finances
        <span>monthly</span>
      </button>
    </aside>

    <!-- MAIN -->
    <div class="main">
      <!-- TOP HEADER -->
      <div class="header-top">
        <div class="title-block">
          <div class="app-title">Overview</div>
          <div class="app-subtitle" id="headerDate">Loadingâ€¦</div>
        </div>
        <div class="header-right">
          <div class="pill">
            <span class="pill-dot"></span>
            <span id="shiftStatus">Shift status loadingâ€¦</span>
          </div>
          <button class="autosave-toggle" id="autoSaveToggleBtn">Auto-save: Off</button>
        </div>
      </div>

      <!-- VIEWS -->
      <div class="view-container">
        <!-- CALENDAR VIEW -->
        <section class="view active" id="view-calendar">
          <div class="calendar-shell">
            <div class="cal-header">
              <button class="cal-nav-btn" id="calPrev">&lt; Prev</button>
              <div class="cal-label-wrap">
                <div class="cal-label" id="calLabel">Month</div>
                <div class="cal-filter">
                  <span class="cal-filter-icon">ðŸ“…</span>
                  <input type="month" id="calMonthPicker" />
                </div>
              </div>
              <div class="cal-header-right">
                <div class="tiny" id="calendarSelectedLabel">Selected: -</div>
                <button class="pattern-toggle-btn" id="patternToggleBtn">Edit pattern</button>
                <button class="cal-nav-btn" id="calNext">Next &gt;</button>
              </div>
            </div>

            <div class="cal-grid" id="calGrid"></div>

            <div class="calendar-controls">
              <div class="calendar-buttons">
                <button class="day-type-btn" id="calOffBtn">Toggle day off</button>
                <button class="day-type-btn" id="calHolidayBtn">Toggle holiday</button>
                <button class="day-type-btn" id="calLeadBtn">Toggle leading shift</button>
                <button class="open-tasks-btn" id="openTasksBtn">Add Task</button>
              </div>

              <div class="pattern-editor" id="patternEditor">
                <div class="pattern-row">
                  <label for="patternStartInput">Start date</label>
                  <input type="date" id="patternStartInput" />
                </div>
                <div class="pattern-row">
                  <label for="patternDaysOnInput">Days on</label>
                  <input type="number" id="patternDaysOnInput" min="0" />
                </div>
                <div class="pattern-row">
                  <label for="patternDaysOffInput">Days off</label>
                  <input type="number" id="patternDaysOffInput" min="0" />
                </div>
                <div class="pattern-row">
                  <label for="patternRateInput">Normal Â£/hr</label>
                  <input type="number" step="0.01" id="patternRateInput" />
                </div>
                <div class="pattern-row">
                  <label for="patternLeadRateInput">Lead Â£/hr</label>
                  <input type="number" step="0.01" id="patternLeadRateInput" />
                </div>
                <div class="pattern-row">
                  <label for="patternTaxInput">Tax %</label>
                  <input type="number" step="0.1" id="patternTaxInput" />
                </div>
                <div class="pattern-row" style="justify-content:flex-end;">
                  <button class="pattern-apply-btn" id="patternApplyBtn">Apply pattern</button>
                </div>
              </div>
            </div>
          </div>

          <!-- TODAY PANEL UNDER CALENDAR -->
          <div class="today-panel">
            <div class="today-panel-header">
              <div class="today-panel-title">Today</div>
              <div class="today-panel-date" id="todayPanelDate"></div>
            </div>
            <div class="today-panel-body">
              <div class="today-focus">
                <div class="focus-text" id="todayFocusText"></div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Sleep Target</div>
                <div class="stat-value" id="sleepTargetValue">8 hrs</div>
                <div class="stat-badge">Night shift recovery</div>
                <div class="sleep-controls">
                  <button class="sleep-btn" id="sleepMinus">-</button>
                  <button class="sleep-btn" id="sleepPlus">+</button>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Today's Priority Tasks</div>
                <div class="stat-value" id="priorityCount">0</div>
                <div class="stat-badge">Important tasks for today</div>
              </div>

              <!-- New: tasks for selected date -->
              <div class="selected-tasks-card">
                <div class="stat-label" id="selectedTasksHeader">
                  Tasks for selected date
                </div>
                <div class="selected-tasks-list" id="selectedDateTasksSummary"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- FINANCE VIEW -->
        <section class="view" id="view-finance">
          <div class="section-header">
            <div class="panel-title">Finances</div>
            <div class="cal-filter">
              <span class="cal-filter-icon">ðŸ“…</span>
              <input type="month" id="financeMonthPicker" />
            </div>
          </div>

          <div class="finance-tabs">
            <button class="finance-tab active" data-finview="details">Details</button>
            <button class="finance-tab" data-finview="graphs">Graphs</button>
          </div>

          <!-- Finance Details Panel -->
          <div id="financeDetailsPanel">
            <div class="finance-box">
              <!-- Payslip -->
              <div class="finance-subtitle">Payslip</div>
              <div class="finance-row">
                <div class="finance-label">Month</div>
                <div class="finance-value" id="financeMonthLabel">-</div>
              </div>
              <div class="finance-row">
                <div class="finance-label">Normal shifts</div>
                <div class="finance-value" id="financeNormalDays">-</div>
              </div>
              <div class="finance-row">
                <div class="finance-label">Leading shifts</div>
                <div class="finance-value" id="financeLeadDays">-</div>
              </div>
              <div class="finance-row">
                <div class="finance-label">Holiday (paid)</div>
                <div class="finance-value" id="financeHolidayDays">-</div>
              </div>
              <div class="finance-row">
                <div class="finance-label">Total working days</div>
                <div class="finance-value" id="financeWorkDays">-</div>
              </div>
              <div class="finance-row">
                <div class="finance-label">Gross pay</div>
                <div class="finance-value" id="financeGross">-</div>
              </div>
              <div class="finance-row">
                <div class="finance-label">After tax</div>
                <div class="finance-value" id="financeNet">-</div>
              </div>
              <div class="finance-row">
                <div class="finance-label">Total payslip (net)</div>
                <div class="finance-value" id="financeTotalPayslip">-</div>
              </div>
              <div class="tiny" id="financePayDate">
                Pay date: -
              </div>

              <!-- Side job -->
              <div class="finance-subtitle">Side job</div>
              <div id="sideJobContainer"></div>
              <div class="finance-total-line">
                Side job total: <span id="sideJobTotal">Â£0.00</span>
              </div>

              <!-- Expenses -->
              <div class="finance-subtitle">Expenses</div>
              <div id="expensesContainer"></div>
              <div class="finance-total-line">
                Expenses total: <span id="expensesTotal">Â£0.00</span>
              </div>
            </div>
          </div>

          <!-- Finance Graphs Panel -->
          <div id="financeGraphsPanel" class="finance-graphs-panel">
            <div class="finance-graphs-controls">
              <div class="tiny">
                Graphs for: <span id="graphsMonthLabel">-</span>
              </div>
              <div class="graph-selects">
                <select id="graphDataType">
                  <option value="overview">Overview (Payslip vs Side job vs Expenses)</option>
                  <option value="expenses">Expenses breakdown</option>
                </select>
                <select id="graphType">
                  <option value="bar">Bar chart</option>
                  <option value="line">Line chart</option>
                  <option value="pie">Pie chart</option>
                  <option value="doughnut">Doughnut chart</option>
                </select>
              </div>
            </div>
            <div class="finance-graphs-canvas-wrap">
              <canvas id="financeChart"></canvas>
            </div>
          </div>
        </section>
      </div>

      <div class="footer"></div>

      <!-- TASK DRAWER -->
      <div class="drawer-overlay" id="drawerOverlay">
        <div class="drawer">
          <div class="drawer-header">
            <div>
              <div class="drawer-title" id="drawerDateLabel">Tasks</div>
              <div class="tiny">
                Day type:
                <span id="dayTypeLabel"></span>
              </div>
            </div>
            <button class="drawer-close" id="drawerCloseBtn">Close</button>
          </div>

          <div class="tasks">
            <div class="task-input-row">
              <input
                type="text"
                id="taskInput"
                placeholder="Add a task for selected date..."
              />
              <button id="addTaskBtn">Add</button>
            </div>
            <div class="task-list" id="taskList"></div>
          </div>

          <div style="margin-top:6px;">
            <div class="tiny" style="margin-bottom:2px;">Notes</div>
            <textarea
              id="notesArea"
              class="notes-area"
              placeholder="Write anything here..."
            ></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const STORAGE_KEY = "maism_dashboard_state_v12";

    // Neutral defaults â€“ set via Edit pattern
    let patternConfig = {
      startDate: new Date(),
      daysOn: 0,
      daysOff: 0,
      hourlyRate: 0,
      leadRate: 0,
    };

    const HOURS_PER_SHIFT = 12;
    let taxRate = 0.2; // default 20%, editable

    let autoSaveEnabled = false;
    let unsavedChanges = false;

    let sideJobsByMonth = {};
    let expenses = [];

    let selectedTaskDate = new Date();
    let tasksByDate = {};
    let dayOverrides = {};
    let sleepTarget = 8;

    let calCurrent = new Date();     // calendar month
    let financeCurrent = new Date(); // finance month

    let financeChart = null;

    const notesArea = document.getElementById("notesArea");

    function getShiftType(date) {
      const { startDate, daysOn, daysOff } = patternConfig;
      const cycleLength = daysOn + daysOff;
      if (cycleLength <= 0) return "off";

      const d1 = new Date(startDate);
      const d2 = new Date(date);
      d1.setHours(0, 0, 0, 0);
      d2.setHours(0, 0, 0, 0);

      const diffDays = Math.round(
        (d2.getTime() - d1.getTime()) / (1000 * 60 * 60 * 24)
      );
      const idx = ((diffDays % cycleLength) + cycleLength) % cycleLength;
      return idx < daysOn ? "work" : "off";
    }

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function getMonthKey(year, monthIndex) {
      const y = year;
      const m = String(monthIndex + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    function formatCurrency(value) {
      return "Â£" + value.toFixed(2);
    }

    function saveState(force = false) {
      try {
        if (!autoSaveEnabled && !force) {
          unsavedChanges = true;
          return;
        }
        const state = {
          patternConfig: {
            startDate: patternConfig.startDate.toISOString(),
            daysOn: patternConfig.daysOn,
            daysOff: patternConfig.daysOff,
            hourlyRate: patternConfig.hourlyRate,
            leadRate: patternConfig.leadRate,
          },
          taxRate,
          autoSaveEnabled,
          sleepTarget,
          tasksByDate,
          dayOverrides,
          notes: notesArea ? notesArea.value : "",
          selectedTaskDate: selectedTaskDate.toISOString(),
          calCurrent: calCurrent.toISOString(),
          financeCurrent: financeCurrent.toISOString(),
          sideJobsByMonth,
          expenses,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        unsavedChanges = false;
      } catch (e) {}
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);

        if (data.patternConfig) {
          if (data.patternConfig.startDate)
            patternConfig.startDate = new Date(data.patternConfig.startDate);
          if (typeof data.patternConfig.daysOn === "number")
            patternConfig.daysOn = data.patternConfig.daysOn;
          if (typeof data.patternConfig.daysOff === "number")
            patternConfig.daysOff = data.patternConfig.daysOff;
          if (typeof data.patternConfig.hourlyRate === "number")
            patternConfig.hourlyRate = data.patternConfig.hourlyRate;
          if (typeof data.patternConfig.leadRate === "number")
            patternConfig.leadRate = data.patternConfig.leadRate;
        }

        if (typeof data.taxRate === "number" && data.taxRate >= 0 && data.taxRate <= 1) {
          taxRate = data.taxRate;
        }

        if (typeof data.autoSaveEnabled === "boolean")
          autoSaveEnabled = data.autoSaveEnabled;
        if (typeof data.sleepTarget === "number")
          sleepTarget = data.sleepTarget;
        if (data.tasksByDate && typeof data.tasksByDate === "object")
          tasksByDate = data.tasksByDate;
        if (data.dayOverrides && typeof data.dayOverrides === "object")
          dayOverrides = data.dayOverrides;
        if (notesArea && typeof data.notes === "string")
          notesArea.value = data.notes;

        if (data.selectedTaskDate) {
          const dt = new Date(data.selectedTaskDate);
          if (!isNaN(dt.getTime())) selectedTaskDate = dt;
        }
        if (data.calCurrent) {
          const cc = new Date(data.calCurrent);
          if (!isNaN(cc.getTime())) calCurrent = cc;
        }
        if (data.financeCurrent) {
          const fc = new Date(data.financeCurrent);
          if (!isNaN(fc.getTime())) financeCurrent = fc;
        } else {
          financeCurrent = new Date(calCurrent);
        }

        if (data.sideJobsByMonth && typeof data.sideJobsByMonth === "object") {
          sideJobsByMonth = data.sideJobsByMonth;
        }
        if (Array.isArray(expenses)) {
          expenses = data.expenses;
        }
      } catch (e) {}
    }

    loadState();

    /* AUTOSAVE UI */
    const autoSaveToggleBtn = document.getElementById("autoSaveToggleBtn");

    function renderAutoSaveUI() {
      if (!autoSaveToggleBtn) return;
      autoSaveToggleBtn.textContent =
        "Auto-save: " + (autoSaveEnabled ? "On" : "Off");
    }

    if (autoSaveToggleBtn) {
      autoSaveToggleBtn.addEventListener("click", () => {
        autoSaveEnabled = !autoSaveEnabled;
        if (autoSaveEnabled && unsavedChanges) {
          saveState(true);
        } else {
          saveState(true);
        }
        renderAutoSaveUI();
      });
    }

    renderAutoSaveUI();

    window.addEventListener("beforeunload", (e) => {
      if (!autoSaveEnabled && unsavedChanges) {
        e.preventDefault();
        e.returnValue = "";
      }
    });

    /* HEADER + TODAY */
    function getEffectiveDayType(date) {
      const key = formatDateKey(date);
      const override = dayOverrides[key];
      const base = getShiftType(date);
      return { base, override };
    }

    function getDayTypeLabelText(date) {
      const { base, override } = getEffectiveDayType(date);
      if (override === "holiday") return "Holiday (paid)";
      if (override === "offTaken") return "Day off (taken)";
      if (override === "lead") return "Leading shift (supervisor)";
      if (base === "work") return "Work shift (pattern)";
      return "Off day (pattern)";
    }

    function updateHeader() {
      const now = new Date();
      const headerDateEl = document.getElementById("headerDate");
      const todayPanelDateEl = document.getElementById("todayPanelDate");
      const shiftStatusEl = document.getElementById("shiftStatus");
      const todayFocusTextEl = document.getElementById("todayFocusText");

      const dateString = now.toLocaleDateString(undefined, {
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric",
      });
      headerDateEl.textContent = dateString;

      todayPanelDateEl.textContent = now.toLocaleDateString(undefined, {
        weekday: "short",
        day: "numeric",
        month: "short",
      });

      const { base, override } = getEffectiveDayType(now);
      let statusText;
      if (override === "holiday") statusText = "Today: Holiday (paid)";
      else if (override === "offTaken") statusText = "Today: Day off (taken)";
      else if (override === "lead")
        statusText = "Today: Leading shift (supervisor)";
      else statusText = base === "work" ? "Today: Work shift" : "Today: Off / recovery";

      shiftStatusEl.textContent = statusText;

      if (base === "work" || override === "lead") {
        todayFocusTextEl.textContent =
          "Work day â€“ complete main tasks and protect sleep.";
      } else if (override === "holiday") {
        todayFocusTextEl.textContent = "Paid holiday â€“ rest, reset, and enjoy.";
      } else {
        todayFocusTextEl.textContent =
          "Off day â€“ recovery, planning, and life admin.";
      }
    }

    function renderSleepTarget() {
      const el = document.getElementById("sleepTargetValue");
      if (el) el.textContent = sleepTarget + " hrs";
    }

    const sleepMinusBtn = document.getElementById("sleepMinus");
    const sleepPlusBtn = document.getElementById("sleepPlus");

    sleepMinusBtn.addEventListener("click", () => {
      if (sleepTarget > 4) {
        sleepTarget -= 1;
        renderSleepTarget();
        saveState();
      }
    });

    sleepPlusBtn.addEventListener("click", () => {
      if (sleepTarget < 12) {
        sleepTarget += 1;
        renderSleepTarget();
        saveState();
      }
    });

    const priorityCountEl = document.getElementById("priorityCount");

    function updateTodayPriorityCount() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayKey = formatDateKey(today);
      const list = tasksByDate[todayKey] || [];
      let count = 0;
      list.forEach((task) => {
        if (!task.done && task.important) count++;
      });
      priorityCountEl.textContent = count;
    }

    /* SIDEBAR NAV */
    const navButtons = document.querySelectorAll(".nav-btn");
    const viewCalendar = document.getElementById("view-calendar");
    const viewFinance = document.getElementById("view-finance");

    navButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        navButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const view = btn.getAttribute("data-view");

        if (view === "calendar") {
          viewCalendar.classList.add("active");
          viewFinance.classList.remove("active");
        } else if (view === "finance") {
          viewFinance.classList.add("active");
          viewCalendar.classList.remove("active");
        }
      });
    });

    /* TASKS + DRAWER */
    const drawerOverlay = document.getElementById("drawerOverlay");
    const drawerCloseBtn = document.getElementById("drawerCloseBtn");
    const drawerDateLabel = document.getElementById("drawerDateLabel");
    const dayTypeLabel = document.getElementById("dayTypeLabel");
    const openTasksBtn = document.getElementById("openTasksBtn");

    const taskInput = document.getElementById("taskInput");
    const addTaskBtn = document.getElementById("addTaskBtn");
    const taskListEl = document.getElementById("taskList");

    const selectedDateTasksSummaryEl =
      document.getElementById("selectedDateTasksSummary");
    const selectedTasksHeaderEl =
      document.getElementById("selectedTasksHeader");

    function updateDrawerLabels() {
      const opts = {
        weekday: "short",
        day: "numeric",
        month: "short",
        year: "numeric",
      };
      drawerDateLabel.textContent =
        selectedTaskDate.toLocaleDateString(undefined, opts);
      dayTypeLabel.textContent = getDayTypeLabelText(selectedTaskDate);
    }

    function renderSelectedDateTasksSummary() {
      const key = formatDateKey(selectedTaskDate);
      const list = tasksByDate[key] || [];
      const opts = {
        weekday: "short",
        day: "numeric",
        month: "short",
        year: "numeric",
      };
      selectedTasksHeaderEl.textContent =
        "Tasks for " +
        selectedTaskDate.toLocaleDateString(undefined, opts);

      selectedDateTasksSummaryEl.innerHTML = "";

      if (!list.length) {
        const empty = document.createElement("div");
        empty.className = "tiny";
        empty.textContent = "No tasks added for this date yet.";
        selectedDateTasksSummaryEl.appendChild(empty);
        return;
      }

      list.forEach((task) => {
        const line = document.createElement("div");
        line.className = "selected-task-line";

        const text = document.createElement("div");
        text.className = "selected-task-text";
        text.textContent = (task.important ? "â˜… " : "") + task.text;

        const meta = document.createElement("div");
        meta.className = "selected-task-meta";
        meta.textContent = task.done ? "Done" : "Pending";

        line.appendChild(text);
        line.appendChild(meta);
        selectedDateTasksSummaryEl.appendChild(line);
      });
    }

    function renderTasks() {
      const key = formatDateKey(selectedTaskDate);
      if (!tasksByDate[key]) tasksByDate[key] = [];
      const tasksForDay = tasksByDate[key];

      taskListEl.innerHTML = "";

      tasksForDay.forEach((task) => {
        const item = document.createElement("div");
        item.className = "task-item";

        const main = document.createElement("div");
        main.className = "task-main";

        const check = document.createElement("div");
        check.className = "task-check";
        check.textContent = task.done ? "âœ“" : "";
        check.addEventListener("click", () => {
          task.done = !task.done;
          saveState();
          renderTasks();
          renderSelectedDateTasksSummary();
        });

        const imp = document.createElement("div");
        imp.className = "task-imp-btn" + (task.important ? " important" : "");
        imp.textContent = task.important ? "â˜…" : "â˜†";
        imp.addEventListener("click", () => {
          task.important = !task.important;
          saveState();
          renderTasks();
          renderSelectedDateTasksSummary();
          updateTodayPriorityCount();
        });

        const text = document.createElement("div");
        text.className = "task-text";
        if (task.done) text.classList.add("done");
        text.textContent = task.text;

        main.appendChild(check);
        main.appendChild(imp);
        main.appendChild(text);

        const del = document.createElement("div");
        del.className = "task-delete";
        del.textContent = "âœ•";
        del.addEventListener("click", () => {
          tasksByDate[key] = tasksByDate[key].filter((t) => t.id !== task.id);
          saveState();
          renderTasks();
          renderSelectedDateTasksSummary();
          updateTodayPriorityCount();
        });

        item.appendChild(main);
        item.appendChild(del);
        taskListEl.appendChild(item);
      });

      updateTodayPriorityCount();
    }

    function addTask() {
      const text = taskInput.value.trim();
      if (!text) return;
      const key = formatDateKey(selectedTaskDate);
      if (!tasksByDate[key]) tasksByDate[key] = [];
      tasksByDate[key].unshift({
        id: Date.now(),
        text,
        done: false,
        important: false,
      });
      taskInput.value = "";
      saveState();
      renderTasks();
      renderSelectedDateTasksSummary();
    }

    addTaskBtn.addEventListener("click", addTask);
    taskInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addTask();
    });

    if (notesArea) {
      notesArea.addEventListener("input", () => {
        saveState();
      });
    }

    function openDrawer() {
      updateDrawerLabels();
      renderTasks();
      drawerOverlay.classList.add("open");
    }

    function closeDrawer() {
      drawerOverlay.classList.remove("open");
    }

    openTasksBtn.addEventListener("click", openDrawer);
    drawerCloseBtn.addEventListener("click", closeDrawer);
    drawerOverlay.addEventListener("click", (e) => {
      if (e.target === drawerOverlay) closeDrawer();
    });

    /* FINANCE LOGIC */
    const financeMonthLabelEl = document.getElementById("financeMonthLabel");
    const financeNormalDaysEl = document.getElementById("financeNormalDays");
    const financeLeadDaysEl = document.getElementById("financeLeadDays");
    const financeHolidayDaysEl = document.getElementById("financeHolidayDays");
    const financeWorkDaysEl = document.getElementById("financeWorkDays");
    const financeGrossEl = document.getElementById("financeGross");
    const financeNetEl = document.getElementById("financeNet");
    const financeTotalPayslipEl = document.getElementById("financeTotalPayslip");
    const financePayDateEl = document.getElementById("financePayDate");

    const sideJobContainer = document.getElementById("sideJobContainer");
    const expensesContainer = document.getElementById("expensesContainer");

    const sideJobTotalEl = document.getElementById("sideJobTotal");
    const expensesTotalEl = document.getElementById("expensesTotal");

    const graphsMonthLabelEl = document.getElementById("graphsMonthLabel");
    const graphDataTypeSelect = document.getElementById("graphDataType");
    const graphTypeSelect = document.getElementById("graphType");

    function calculateMonthFinance(year, monthIndex) {
      const lastDay = new Date(year, monthIndex + 1, 0);
      let normalDays = 0;
      let leadDays = 0;
      let holidayDays = 0;
      let gross = 0;

      const normalRate = patternConfig.hourlyRate || 0;
      const leadRate = patternConfig.leadRate || 0;

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateObj = new Date(year, monthIndex, d);
        const baseType = getShiftType(dateObj);
        const key = formatDateKey(dateObj);
        const override = dayOverrides[key];

        let works = false;
        let rate = normalRate;

        if (override === "offTaken") {
          works = false;
        } else if (override === "holiday") {
          works = true;
          rate = normalRate;
          holidayDays++;
        } else if (override === "lead") {
          works = true;
          rate = leadRate;
          leadDays++;
        } else if (baseType === "work") {
          works = true;
          rate = normalRate;
          normalDays++;
        }

        if (works) {
          gross += HOURS_PER_SHIFT * rate;
        }
      }

      const net = gross * (1 - taxRate);
      const totalDays = normalDays + leadDays + holidayDays;

      let payMonth = monthIndex + 1;
      let payYear = year;
      if (payMonth > 11) {
        payMonth = 0;
        payYear += 1;
      }
      const payDate = new Date(payYear, payMonth, 15);

      return { normalDays, leadDays, holidayDays, totalDays, gross, net, payDate };
    }

    function ensureMonthSideJobs(year, monthIndex) {
      const key = getMonthKey(year, monthIndex);
      if (!sideJobsByMonth[key]) {
        sideJobsByMonth[key] = { weeksCount: 4, jobs: [] };
      }
      const data = sideJobsByMonth[key];
      if (!data.weeksCount || data.weeksCount < 1) data.weeksCount = 4;
      const weeksCount = data.weeksCount;

      data.jobs.forEach((job) => {
        if (!Array.isArray(job.weeks)) job.weeks = [];
        while (job.weeks.length < weeksCount) job.weeks.push(0);
        if (job.weeks.length > weeksCount) job.weeks = job.weeks.slice(0, weeksCount);
      });
    }

    function computeSideJobTotalForMonth(year, monthIndex) {
      const key = getMonthKey(year, monthIndex);
      ensureMonthSideJobs(year, monthIndex);
      const data = sideJobsByMonth[key];
      let total = 0;
      data.jobs.forEach((job) => {
        job.weeks.forEach((v) => {
          const val = typeof v === "number" && !isNaN(v) ? v : 0;
          total += val;
        });
      });
      return total;
    }

    function computeTotalExpenses() {
      if (!Array.isArray(expenses) || expenses.length === 0) return 0;
      return expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
    }

    function renderSideJobs() {
      const year = financeCurrent.getFullYear();
      const month = financeCurrent.getMonth();
      const monthKey = getMonthKey(year, month);
      ensureMonthSideJobs(year, month);
      const data = sideJobsByMonth[monthKey];
      const weeksCount = data.weeksCount;

      sideJobContainer.innerHTML = "";

      const topBar = document.createElement("div");
      topBar.className = "sidejob-topbar";

      const weeksLabel = document.createElement("div");
      weeksLabel.textContent =
        "Weeks in this month for side job: " + weeksCount;

      const addWeekBtn = document.createElement("button");
      addWeekBtn.className = "sidejob-week-btn";
      addWeekBtn.textContent = "Add week";
      addWeekBtn.addEventListener("click", () => {
        data.weeksCount += 1;
        data.jobs.forEach((job) => job.weeks.push(0));
        saveState();
        renderSideJobs();
        updateFinanceTotalsAndChart();
      });

      topBar.appendChild(weeksLabel);
      topBar.appendChild(addWeekBtn);
      sideJobContainer.appendChild(topBar);

      const addRow = document.createElement("div");
      addRow.className = "sidejob-add-row";
      const addInput = document.createElement("input");
      addInput.type = "text";
      addInput.placeholder = "New side job (e.g. Just Eat)";
      addInput.className = "sidejob-add-input";
      const addBtn = document.createElement("button");
      addBtn.className = "sidejob-add-btn";
      addBtn.textContent = "Add";

      addBtn.addEventListener("click", () => {
        const name = addInput.value.trim();
        if (!name) return;
        const id = Date.now() + Math.random();
        const weeks = Array(weeksCount).fill(0);
        data.jobs.push({ id, name, weeks });
        addInput.value = "";
        saveState();
        renderSideJobs();
        updateFinanceTotalsAndChart();
      });

      addRow.appendChild(addInput);
      addRow.appendChild(addBtn);
      sideJobContainer.appendChild(addRow);

      if (data.jobs.length === 0) {
        const info = document.createElement("div");
        info.className = "tiny";
        info.textContent = "No side jobs added for this month.";
        sideJobContainer.appendChild(info);
        updateFinanceTotalsAndChart();
        return;
      }

      data.jobs.forEach((job) => {
        const row = document.createElement("div");
        row.className = "sidejob-row";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = job.name;
        nameInput.className = "sidejob-name";
        nameInput.addEventListener("input", () => {
          job.name = nameInput.value;
          saveState();
        });
        row.appendChild(nameInput);

        job.weeks.forEach((val, idx) => {
          const weekInput = document.createElement("input");
          weekInput.type = "number";
          weekInput.className = "sidejob-input";
          weekInput.placeholder = "W" + (idx + 1);
          weekInput.value =
            typeof val === "number" && !isNaN(val) ? val : 0;
          weekInput.addEventListener("input", () => {
            const v = parseFloat(weekInput.value);
            job.weeks[idx] = isNaN(v) ? 0 : v;
            saveState();
            updateFinanceTotalsAndChart();
          });
          row.appendChild(weekInput);
        });

        const delBtn = document.createElement("button");
        delBtn.className = "row-delete-btn";
        delBtn.textContent = "âœ•";
        delBtn.addEventListener("click", () => {
          data.jobs = data.jobs.filter((j) => j.id !== job.id);
          saveState();
          renderSideJobs();
          updateFinanceTotalsAndChart();
        });
        row.appendChild(delBtn);

        sideJobContainer.appendChild(row);
      });

      updateFinanceTotalsAndChart();
    }

    function renderExpenses() {
      expensesContainer.innerHTML = "";

      const addRow = document.createElement("div");
      addRow.className = "expenses-add-row";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Expense name";
      nameInput.className = "expense-add-name";

      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.placeholder = "0";
      amountInput.className = "expense-add-amount";

      const addBtn = document.createElement("button");
      addBtn.className = "expense-add-btn";
      addBtn.textContent = "Add";

      addBtn.addEventListener("click", () => {
        const name = nameInput.value.trim();
        const val = parseFloat(amountInput.value);
        if (!name || isNaN(val)) return;
        const id = Date.now() + Math.random();
        expenses.push({ id, name, amount: val });
        nameInput.value = "";
        amountInput.value = "";
        saveState();
        renderExpenses();
        updateFinanceTotalsAndChart();
      });

      addRow.appendChild(nameInput);
      addRow.appendChild(amountInput);
      addRow.appendChild(addBtn);
      expensesContainer.appendChild(addRow);

      if (!Array.isArray(expenses) || expenses.length === 0) {
        const info = document.createElement("div");
        info.className = "tiny";
        info.textContent = "No expenses listed.";
        expensesContainer.appendChild(info);
        updateFinanceTotalsAndChart();
        return;
      }

      const sorted = [...expenses].sort((a, b) => b.amount - a.amount);

      sorted.forEach((exp) => {
        const row = document.createElement("div");
        row.className = "expenses-row";

        const name = document.createElement("input");
        name.type = "text";
        name.value = exp.name;
        name.className = "expense-name";
        name.addEventListener("input", () => {
          const orig = expenses.find((e) => e.id === exp.id);
          if (orig) {
            orig.name = name.value;
            saveState();
          }
        });

        const amount = document.createElement("input");
        amount.type = "number";
        amount.value = exp.amount;
        amount.className = "expense-amount";
        amount.addEventListener("input", () => {
          const orig = expenses.find((e) => e.id === exp.id);
          if (orig) {
            const v = parseFloat(amount.value);
            orig.amount = isNaN(v) ? 0 : v;
            saveState();
            renderExpenses();
            updateFinanceTotalsAndChart();
          }
        });

        const delBtn = document.createElement("button");
        delBtn.className = "row-delete-btn";
        delBtn.textContent = "âœ•";
        delBtn.addEventListener("click", () => {
          expenses = expenses.filter((e) => e.id !== exp.id);
          saveState();
          renderExpenses();
          updateFinanceTotalsAndChart();
        });

        row.appendChild(name);
        row.appendChild(amount);
        row.appendChild(delBtn);

        expensesContainer.appendChild(row);
      });

      updateFinanceTotalsAndChart();
    }

    function renderGraphsMonthLabel() {
      const year = financeCurrent.getFullYear();
      const month = financeCurrent.getMonth();
      const labelDate = new Date(year, month, 1);
      graphsMonthLabelEl.textContent = labelDate.toLocaleString(undefined, {
        month: "long",
        year: "numeric",
      });
    }

    function updateFinanceChart() {
      if (typeof Chart === "undefined") return;
      const canvas = document.getElementById("financeChart");
      if (!canvas) return;

      const year = financeCurrent.getFullYear();
      const month = financeCurrent.getMonth();
      const { net } = calculateMonthFinance(year, month);
      const sideTotal = computeSideJobTotalForMonth(year, month);
      const expensesTotal = computeTotalExpenses();

      const dataType = graphDataTypeSelect.value;
      const chartType = graphTypeSelect.value;

      let labels = [];
      let data = [];
      let datasetLabel = "";

      if (dataType === "overview") {
        labels = ["Payslip (net)", "Side job", "Expenses"];
        data = [net, sideTotal, expensesTotal];
        datasetLabel = "Monthly overview";
      } else {
        datasetLabel = "Expenses breakdown";
        if (!Array.isArray(expenses) || expenses.length === 0) {
          labels = ["No expenses"];
          data = [0];
        } else {
          const sorted = [...expenses].sort((a, b) => b.amount - a.amount);
          labels = sorted.map((e) => e.name);
          data = sorted.map((e) => e.amount);
        }
      }

      const ctx = canvas.getContext("2d");
      if (financeChart) {
        financeChart.destroy();
      }

      financeChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels,
          datasets: [
            {
              label: datasetLabel,
              data,
              backgroundColor: [
                "#60a5fa",
                "#34d399",
                "#f97316",
                "#a855f7",
                "#facc15",
                "#f87171",
              ],
              borderColor: "#e5e7eb",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales:
            chartType === "bar" || chartType === "line"
              ? {
                  y: { beginAtZero: true },
                }
              : {},
          plugins: {
            legend: { display: true },
          },
        },
      });
    }

    function updateFinanceTotalsAndChart() {
      const year = financeCurrent.getFullYear();
      const month = financeCurrent.getMonth();
      const sideTotal = computeSideJobTotalForMonth(year, month);
      const expensesTotal = computeTotalExpenses();

      if (sideJobTotalEl) sideJobTotalEl.textContent = formatCurrency(sideTotal);
      if (expensesTotalEl) expensesTotalEl.textContent = formatCurrency(expensesTotal);

      updateFinanceChart();
    }

    function renderFinance() {
      const year = financeCurrent.getFullYear();
      const month = financeCurrent.getMonth();

      const { normalDays, leadDays, holidayDays, totalDays, gross, net, payDate } =
        calculateMonthFinance(year, month);

      const monthLabelDate = new Date(year, month, 1);
      financeMonthLabelEl.textContent = monthLabelDate.toLocaleString(
        undefined,
        { month: "long", year: "numeric" }
      );

      financeNormalDaysEl.textContent = normalDays;
      financeLeadDaysEl.textContent = leadDays;
      financeHolidayDaysEl.textContent = holidayDays;
      financeWorkDaysEl.textContent = totalDays;
      financeGrossEl.textContent =
        totalDays === 0 ? "Â£0.00" : formatCurrency(gross);
      financeNetEl.textContent =
        totalDays === 0 ? "Â£0.00" : formatCurrency(net);
      financeTotalPayslipEl.textContent =
        totalDays === 0 ? "Â£0.00" : formatCurrency(net);

      financePayDateEl.textContent =
        "Pay date: " +
        payDate.toLocaleDateString(undefined, {
          day: "numeric",
          month: "long",
          year: "numeric",
        });

      const financeMonthPicker = document.getElementById("financeMonthPicker");
      if (financeMonthPicker) {
        const fy = year;
        const fm = String(month + 1).padStart(2, "0");
        financeMonthPicker.value = `${fy}-${fm}`;
      }

      renderGraphsMonthLabel();
      renderSideJobs();
      renderExpenses();
      updateFinanceTotalsAndChart();
    }

    /* CALENDAR */
    const calGrid = document.getElementById("calGrid");
    const calLabel = document.getElementById("calLabel");
    const calPrevBtn = document.getElementById("calPrev");
    const calNextBtn = document.getElementById("calNext");
    const calendarSelectedLabelEl =
      document.getElementById("calendarSelectedLabel");
    const calMonthPicker = document.getElementById("calMonthPicker");

    function pad(n) {
      return n < 10 ? "0" + n : "" + n;
    }

    function renderCalendarSelectedLabel() {
      const opts = {
        weekday: "short",
        day: "numeric",
        month: "short",
        year: "numeric",
      };
      calendarSelectedLabelEl.textContent =
        "Selected: " +
        selectedTaskDate.toLocaleDateString(undefined, opts) +
        " â€“ " +
        getDayTypeLabelText(selectedTaskDate);
    }

    function renderCalendar() {
      const year = calCurrent.getFullYear();
      const month = calCurrent.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const totalDays = lastDay.getDate();

      calLabel.textContent = calCurrent.toLocaleString(undefined, {
        month: "long",
        year: "numeric",
      });

      if (calMonthPicker) {
        const ym = `${year}-${pad(month + 1)}`;
        calMonthPicker.value = ym;
      }

      calGrid.innerHTML = "";

      const dayNames = ["M", "T", "W", "T", "F", "S", "S"];
      dayNames.forEach((d) => {
        const el = document.createElement("div");
        el.className = "cal-day-name";
        el.textContent = d;
        calGrid.appendChild(el);
      });

      const startIdx = (firstDay.getDay() + 6) % 7;
      for (let i = 0; i < startIdx; i++) {
        const empty = document.createElement("div");
        calGrid.appendChild(empty);
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      for (let d = 1; d <= totalDays; d++) {
        const dateObj = new Date(year, month, d);
        dateObj.setHours(0, 0, 0, 0);

        const el = document.createElement("div");
        el.className = "cal-day";
        el.textContent = d;

        const key = formatDateKey(dateObj);
        const override = dayOverrides[key];

        if (override === "holiday") {
          el.classList.add("holiday");
        } else if (override === "offTaken") {
          el.classList.add("extra-off");
        } else if (override === "lead") {
          el.classList.add("lead");
        } else {
          const baseType = getShiftType(dateObj);
          if (baseType === "work") el.classList.add("night");
          if (baseType === "off") el.classList.add("off");
        }

        if (dateObj.getTime() === today.getTime()) {
          el.classList.add("today");
        }

        if (
          dateObj.getTime() ===
          new Date(
            selectedTaskDate.getFullYear(),
            selectedTaskDate.getMonth(),
            selectedTaskDate.getDate()
          ).getTime()
        ) {
          el.classList.add("selected-date");
        }

        el.addEventListener("click", () => {
          selectedTaskDate = new Date(year, month, d);
          saveState();
          renderCalendar();
          renderCalendarSelectedLabel();
          renderSelectedDateTasksSummary();
          updateDrawerLabels();
          renderFinance();
        });

        calGrid.appendChild(el);
      }

      renderCalendarSelectedLabel();
    }

    const financeMonthPicker = document.getElementById("financeMonthPicker");
    if (financeMonthPicker) {
      financeMonthPicker.addEventListener("input", () => {
        const v = financeMonthPicker.value;
        if (!v) return;
        const [y, m] = v.split("-");
        const yy = parseInt(y, 10);
        const mm = parseInt(m, 10) - 1;
        if (!isNaN(yy) && !isNaN(mm)) {
          financeCurrent = new Date(yy, mm, 1);
          saveState();
          renderFinance();
        }
      });
    }

    calPrevBtn.addEventListener("click", () => {
      calCurrent.setMonth(calCurrent.getMonth() - 1);
      saveState();
      renderCalendar();
      renderFinance();
      renderSelectedDateTasksSummary();
    });

    calNextBtn.addEventListener("click", () => {
      calCurrent.setMonth(calCurrent.getMonth() + 1);
      saveState();
      renderCalendar();
      renderFinance();
      renderSelectedDateTasksSummary();
    });

    if (calMonthPicker) {
      calMonthPicker.addEventListener("input", () => {
        const v = calMonthPicker.value;
        if (!v) return;
        const [y, m] = v.split("-");
        const yy = parseInt(y, 10);
        const mm = parseInt(m, 10) - 1;
        if (!isNaN(yy) && !isNaN(mm)) {
          calCurrent = new Date(yy, mm, 1);
          saveState();
          renderCalendar();
          renderFinance();
          renderSelectedDateTasksSummary();
        }
      });
    }

    const calOffBtn = document.getElementById("calOffBtn");
    const calHolidayBtn = document.getElementById("calHolidayBtn");
    const calLeadBtn = document.getElementById("calLeadBtn");

    calOffBtn.addEventListener("click", () => {
      const key = formatDateKey(selectedTaskDate);
      if (dayOverrides[key] === "offTaken") {
        delete dayOverrides[key];
      } else {
        dayOverrides[key] = "offTaken";
      }
      saveState();
      updateHeader();
      renderCalendar();
      renderCalendarSelectedLabel();
      renderFinance();
      updateDrawerLabels();
    });

    calHolidayBtn.addEventListener("click", () => {
      const key = formatDateKey(selectedTaskDate);
      if (dayOverrides[key] === "holiday") {
        delete dayOverrides[key];
      } else {
        dayOverrides[key] = "holiday";
      }
      saveState();
      updateHeader();
      renderCalendar();
      renderCalendarSelectedLabel();
      renderFinance();
      updateDrawerLabels();
    });

    calLeadBtn.addEventListener("click", () => {
      const key = formatDateKey(selectedTaskDate);
      if (dayOverrides[key] === "lead") {
        delete dayOverrides[key];
      } else {
        dayOverrides[key] = "lead";
      }
      saveState();
      updateHeader();
      renderCalendar();
      renderCalendarSelectedLabel();
      renderFinance();
      updateDrawerLabels();
    });

    /* PATTERN EDITOR */
    const patternToggleBtn = document.getElementById("patternToggleBtn");
    const patternEditor = document.getElementById("patternEditor");
    const patternStartInput = document.getElementById("patternStartInput");
    const patternDaysOnInput = document.getElementById("patternDaysOnInput");
    const patternDaysOffInput = document.getElementById("patternDaysOffInput");
    const patternRateInput = document.getElementById("patternRateInput");
    const patternLeadRateInput = document.getElementById("patternLeadRateInput");
    const patternTaxInput = document.getElementById("patternTaxInput");
    const patternApplyBtn = document.getElementById("patternApplyBtn");

    function loadPatternIntoInputs() {
      const d = patternConfig.startDate;
      const iso =
        d.getFullYear() +
        "-" +
        pad(d.getMonth() + 1) +
        "-" +
        pad(d.getDate());
      patternStartInput.value = iso;
      patternDaysOnInput.value = patternConfig.daysOn || 0;
      patternDaysOffInput.value = patternConfig.daysOff || 0;
      patternRateInput.value =
        typeof patternConfig.hourlyRate === "number"
          ? patternConfig.hourlyRate.toFixed(2)
          : "";
      patternLeadRateInput.value =
        typeof patternConfig.leadRate === "number"
          ? patternConfig.leadRate.toFixed(2)
          : "";
      patternTaxInput.value = (taxRate * 100).toFixed(1);
    }

    patternToggleBtn.addEventListener("click", () => {
      if (
        patternEditor.style.display === "none" ||
        patternEditor.style.display === ""
      ) {
        loadPatternIntoInputs();
        patternEditor.style.display = "flex";
        patternToggleBtn.textContent = "Hide pattern";
      } else {
        patternEditor.style.display = "none";
        patternToggleBtn.textContent = "Edit pattern";
      }
    });

    patternApplyBtn.addEventListener("click", () => {
      const startVal = patternStartInput.value;
      const daysOnVal = parseInt(patternDaysOnInput.value, 10);
      const daysOffVal = parseInt(patternDaysOffInput.value, 10);
      const rateVal = parseFloat(patternRateInput.value);
      const leadRateVal = parseFloat(patternLeadRateInput.value);
      const taxVal = parseFloat(patternTaxInput.value);

      if (startVal) {
        const parts = startVal.split("-");
        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const d = parseInt(parts[2], 10);
        patternConfig.startDate = new Date(y, m, d);
      }

      if (!isNaN(daysOnVal) && daysOnVal >= 0) patternConfig.daysOn = daysOnVal;
      if (!isNaN(daysOffVal) && daysOffVal >= 0)
        patternConfig.daysOff = daysOffVal;
      if (!isNaN(rateVal) && rateVal >= 0) patternConfig.hourlyRate = rateVal;
      if (!isNaN(leadRateVal) && leadRateVal >= 0)
        patternConfig.leadRate = leadRateVal;

      if (!isNaN(taxVal) && taxVal >= 0 && taxVal <= 100) {
        taxRate = taxVal / 100;
      }

      saveState();
      updateHeader();
      renderCalendar();
      renderFinance();
      updateDrawerLabels();
    });

    /* FINANCE TABS (DETAILS / GRAPHS) */
    const financeTabButtons = document.querySelectorAll(".finance-tab");
    const financeDetailsPanel = document.getElementById("financeDetailsPanel");
    const financeGraphsPanel = document.getElementById("financeGraphsPanel");

    financeTabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        financeTabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const view = btn.getAttribute("data-finview");

        if (view === "details") {
          financeDetailsPanel.style.display = "block";
          financeGraphsPanel.classList.remove("active");
        } else {
          financeDetailsPanel.style.display = "none";
          financeGraphsPanel.classList.add("active");
          updateFinanceChart();
        }
      });
    });

    if (graphDataTypeSelect) {
      graphDataTypeSelect.addEventListener("change", updateFinanceChart);
    }
    if (graphTypeSelect) {
      graphTypeSelect.addEventListener("change", updateFinanceChart);
    }

    /* INITIAL RENDER */
    updateHeader();
    renderSleepTarget();
    renderCalendar();
    renderFinance();
    updateDrawerLabels();
    renderTasks();
    renderSelectedDateTasksSummary();
    updateTodayPriorityCount();
  </script>
</body>
</html>
